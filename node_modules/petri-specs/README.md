# petri-specs

> petri-specs is a CLI tool used to generate a json spec file that defines the experiments aspects used by petri.


## Installation
Install petri-specs CLI tool:

```bash
$ npm install -g petri-specs
```

## Create new specs
Generate a local `json` spec file under `<project-root>/petri-specs/specs.<specName>.json`:

```bash
$ petri-specs new

[?] Spec name: specs.<myNamespace>.<MySpecName> (specs.cx.IsMyButtonBig)
[?] Scope Name: <scope-name> (my-account)
[?] Owner email: <team>@wix.com (my-team@wix.com)
[?] Scope Type: (Use arrow keys)

> Only for logged in users
  All user types

```
__Note:__ make sure that the SpecName is PascalCased.

## Building specs
A project may have several specs in it. It is required to combine them before publishing.

### Building specs automatically:
#### Using [yoshi](https://github.com/wix/yoshi):
If you are using [yoshi](https://github.com/wix/yoshi), it will automatically build it for you after the build passes on ci.
#### Without yoshi:

If your project is not a yoshi project, just add to your package.json under scripts:
```
  "scripts": {
    "build": "petri-specs build --json dist/statics/petri-experiments.json",
  }
```
You can replace `dist/statics/petri-experiments.json` with any path you want.

Don't forget to run `npm install --save-dev petri-spcecs`.

##### Configure pom.xml in non yoshi projects:
In order for everything to work, you need to make sure that your pom.xml file contains the following build section:
```
 <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-assembly-plugin</artifactId>
                <version>2.2.1</version>
                <executions>
                    <execution>
                        <id>petri-experiments</id>
                        <phase>prepare-package</phase>
                        <goals>
                            <goal>single</goal>
                        </goals>
                        <configuration>
                            <descriptor>etc/petri.tar.gz.xml</descriptor>
                            <appendAssemblyId>false</appendAssemblyId>
                            <finalName>${project.artifactId}-${project.version}</finalName>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>
```

and in the root of your project make sure you have the etc folder with the `petri.tar.gz.xml`:
```
<assembly xmlns="http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.0"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://maven.apache.org/plugins/maven-assembly-plugin/assembly/1.1.0                  http://maven.apache.org/xsd/assembly-1.1.0.xsd">
    <id>bundle</id>
    <baseDirectory>/</baseDirectory>
    <formats>
        <format>tar.gz</format>
    </formats>
    <fileSets>
        <fileSet>
            <directory>${project.basedir}/dist/statics</directory>
            <outputDirectory>/</outputDirectory>
            <includes>
                <include>*</include>
                <include>*/**</include>
            </includes>
        </fileSet>
    </fileSets>
</assembly>

```

You can choose to put this file in any folder you want and name it whatever you want, but you **can't** put it in the root folder directly. 

**Importent**: make sure that `<directory>${project.basedir}/dist/statics</directory>` is pointing to the location of the folder that contains your petri-experiments.json file output.


### Building specs manually:
If you need to generate it manually, run in your project folder: `petri-specs build`. Building the specs creates a combined file of specs from both of your specs directory (`/petri-specs` by default) and your translation files (`/src/assets/*_en.json`).
By default, petri-specs will generate the combind file to `dist/petri-experiments.json`, but it can be configured differently:

```
petri-specs-build [options]

  Options:

    -V, --version       output the version number
    --directory <path>  specs directory
    --json <file-path>  output file for specs feeder
    --ts <file-path>    typescript definitions
    --js <file-path>    javascript definitions
    -h, --help          output usage information

  Options relevant only to translation specs:
    --scopes <scopes>                                     comma separated scopes for the translation specs (optional)
    --only-for-logged-in-users [isOnlyForLoggedInUsers]   will the translations specs be created only for logged in users (optional)
```

## Publishing specs
Before you can create an experiment of this spec, you should publish the generated combined `json` file.
In order to publish the spec, push your code, wait for the build to pass and then do one of the followings:

### Automatic specs scanning:
When you deploy your project to production (RC and GA), a process called specs-feeder will scan for those json files and define your experiments in petri.

### Scanning specs manually:
In your project folder run: `petri-specs update`. It will sync the specs with the petri server and you can generate experiments from petri.

## Creating experiments
After publishing the spec, it will become visible on [guineapig](https://guineapig.wix.com/home).
You will now be able to create a new experiment out of it. Read more about it [here](https://github.com/wix-private/fed-handbook/blob/master/EXPERIMENTS.md#add-a-new-experiment-on-guineapig).

## Testkit
Helpful way to Mock some relevant files like spec and pom.

In order to use it:
```
import petriTestkit from 'petri-specs/test/testkit';
```

#### API:
| Method | Arguments | Returned value |	Description |
|----------|----------|----------|----------|
| baseFsWith | specs  | object | extends the given specs object with pom and empty package.json files |
| spec | spec key | object | generates a spec file object for the given spec key |
| pom | - | object | generates a pom.xml file object |
| translationSpec | spec key | object | generates a spec file with translation index groups |
| translationWithSpecs | specs | object | generates translation file for the given specs |
