const readDirectory = require('./utils/read-directory');
const writeFile = require('./utils/file-write-logger');
const fs = require('fs');
const chalk = require('chalk');
const convertSpec = require('./utils/file-convertor');
const isEqual = require('lodash.isequal');
const validateSpec = require('./utils/validations');

module.exports = function(options) {
  const files = readDirectory(options.directory);
  let convertedFilesCount = 0;
  files.forEach(file => {
    const spec = JSON.parse(fs.readFileSync(file));
    const specName = Object.keys(spec)[0];
    if (validateSpec(spec[specName])) {
      const convertedSpec = convertSpec(spec);
      if (!isEqual(spec, convertedSpec)) {
        convertedFilesCount++;
        writeFile(file, JSON.stringify(convertedSpec, null, 2));
      }
    }
  });

  console.log(chalk.white(`converted ${chalk.green(convertedFilesCount)} specs`));
  return {convertedFilesCount};
}
