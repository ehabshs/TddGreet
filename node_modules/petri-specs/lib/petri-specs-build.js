'use strict';

const writeFile = require('./utils/file-write-logger');
const readDirectory = require('./utils/read-directory');
const chalk = require('chalk');
const fs = require('fs');
const { getTranslationSpecs } = require('ab-translate');
const validateSpec = require('./utils/validations');

module.exports = function(options) {
  const files = readDirectory(options.directory);
  const experiments = files
    .map(file => JSON.parse(fs.readFileSync(file)))
    .reduce((prev, obj) => Object.assign(prev, obj), {});
  const translationExperiments = getTranslationSpecs(options);
  const allExperiments = Object.assign({}, experiments, translationExperiments);

  const validExperiments = {};
  Object.keys(allExperiments).forEach(spec => {
    if (!validateSpec(allExperiments[spec])) {
      console.warn('"' + spec + '" is not a valid spec');
    } else {
      validExperiments[spec] = allExperiments[spec];
    }
  });

  if (Object.keys(validExperiments).length > 0) {
    writeFile(options.json, JSON.stringify(validExperiments, null, 2));
  }
  console.log(
    chalk.white(`found ${chalk.green(Object.keys(validExperiments).length)} valid specs`)
  );
};
